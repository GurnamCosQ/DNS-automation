name: Hosted Zone Onboarding (Dispatch to tf-security)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: read

jobs:
  dispatch:
    # Only run for issues created by the Hosted Zone Onboarding form (it applies the hosted-zone label)
    if: |
      github.event.issue && 
      contains(github.event.issue.labels.*.name, 'hosted-zone')
    runs-on: ubuntu-latest

    steps:
      - name: Parse issue form + dispatch tf-security workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TFSEC_WORKFLOW_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body  = issue.body || "";

            function getField(label) {
              // Issue forms render as:
              // ### Label
              //
              // value
              const re = new RegExp(`^###\\s+${label}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###\\s+|\\n\\n$|$)`, "m");
              const m = body.match(re);
              return (m && m[1]) ? m[1].trim() : "";
            }

            const stepRaw     = getField("Step to run");
            const zoneRaw     = getField("Zone domain");
            const privateRaw  = getField("Private zone\\?");
            const snowIdRaw   = getField("SNOW ID");

            if (!stepRaw || !zoneRaw || !privateRaw || !snowIdRaw) {
              core.setFailed(`Missing required fields. Parsed: step='${stepRaw}', zone='${zoneRaw}', private='${privateRaw}', snow_id='${snowIdRaw}'`);
              return;
            }

            const step = stepRaw.startsWith("1") ? "1" : "2";
            const action = (step === "1") ? "append_domain" : "create_zone_file";

            // Normalize inputs lightly (bot will do final normalization)
            const zone = zoneRaw.trim().replace(/\s+/g, "");
            const private_zone = (privateRaw.trim().toLowerCase() === "true") ? "true" : "false";
            const snow_id = snowIdRaw.trim();

            const owner = "MarkAnthonyGroup2";   // <- change if needed
            const repo  = "tf-security";         // <- target repo
            const workflowFile = "hosted-zone-bot.yml"; // <- target workflow filename

            await github.request("POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches", {
              owner,
              repo,
              workflow_id: workflowFile,
              ref: "main",
              inputs: {
                action,
                zone,
                private_zone,
                snow_id,
                issue_number: String(issue.number),
                issue_url: issue.html_url
              }
            });

            core.info(`Dispatched ${owner}/${repo} workflow '${workflowFile}' with action='${action}', zone='${zone}', private_zone='${private_zone}', snow_id='${snow_id}'.`);
